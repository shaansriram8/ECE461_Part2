name: CD - Deploy FastAPI to ECS/Fargate

# Requirements:
# - Automated deployment to AWS upon merge to main
# - Backend accessible via ALB and API Gateway
# 
# Prerequisites (manual setup required):
# - ECR repository: ece461-backend in us-east-2
# - ECS cluster: ece461-backend-cluster in us-east-2  
# - ECS task definition: ece461-backend-task (created once manually)
# - ECS service: ece461-backend-service (created once manually, configured with ALB)
# - Application Load Balancer (ALB) with target group
# - API Gateway REST API (optional - workflow will detect if configured)
# - GitHub OIDC role with ECR/ECS/ELB permissions
# - CloudWatch log group: /ecs/ece461-backend-task
# - GitHub secrets: AWS_IAM_ROLE_ARN

on:
  push:
    branches: [ 'main' ]
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual deploy'
        required: false
        default: 'manual'

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-2
  ECR_REPO: ece461-backend
  ECS_CLUSTER: ece461-backend-cluster
  ECS_SERVICE: ece461-backend-service
  ECS_TASK_DEFINITION: ece461-backend-task
  CONTAINER_NAME: fastapi-app
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps and run tests
        run: |
          python -m pip install --upgrade pip
          pip install -r dependencies.txt
          pip install pytest coverage
          coverage run -m pytest -q || true
          coverage report || true

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_IAM_ROLE_ARN }}
          role-session-name: gha-deploy

      - name: Login to Amazon ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push image
        env:
          ECR_REGISTRY: ${{ steps.ecr-login.outputs.registry }}
        run: |
          docker build --build-arg GIT_SHA=${{ github.sha }} -t $ECR_REGISTRY/${{ env.ECR_REPO }}:${{ env.IMAGE_TAG }} .
          docker push $ECR_REGISTRY/${{ env.ECR_REPO }}:${{ env.IMAGE_TAG }}
          echo "IMAGE_URI=$ECR_REGISTRY/${{ env.ECR_REPO }}:${{ env.IMAGE_TAG }}" >> $GITHUB_ENV

      - name: Update task definition with new image
        run: |
          # Get account ID for role ARN
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          
          # Download current task definition
          aws ecs describe-task-definition \
            --task-definition ${{ env.ECS_TASK_DEFINITION }} \
            --query taskDefinition > task-definition.json
          
          # Update image URI and environment variables using jq (pre-installed in GitHub Actions)
          jq --arg IMAGE "$IMAGE_URI" \
           '.containerDefinitions[0].image = $IMAGE
            | .containerDefinitions[0].secrets = [
                {
                  "name": "GEN_AI_STUDIO_API_KEY",
                  "valueFrom": "/ece461-backend/GEN_AI_STUDIO_API_KEY"
                }
              ]
            | .containerDefinitions[0].environment = [
                {
                  "name": "LOG_LEVEL",
                  "value": "1"
                },
                {
                  "name": "LOG_FILE",
                  "value": "/tmp/error_logs.log"
                },
                {
                  "name": "DDB_TABLE_NAME",
                  "value": "artifacts_metadata"
                },
                {
                  "name": "AWS_REGION",
                  "value": "us-east-2"
                }
              ]' \
           task-definition.json > task-definition-updated.json
           
          # Ensure taskRoleArn is present (service requires it)
          # If it doesn't exist in current task definition, add it
          jq --arg TASK_ROLE "arn:aws:iam::${ACCOUNT_ID}:role/ecs-backend-access-role" \
           '.taskRoleArn = (if .taskRoleArn then .taskRoleArn else $TASK_ROLE end)' \
           task-definition-updated.json > task-definition-with-role.json
           
          # Remove fields that can't be specified on register
          jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .placementConstraints, .compatibilities, .registeredAt, .registeredBy)' \
            task-definition-with-role.json > task-definition-final.json

      - name: Register new task definition revision
        run: |
          aws ecs register-task-definition \
            --cli-input-json file://task-definition-final.json \
            --region ${{ env.AWS_REGION }}

      - name: Update ECS service with new deployment
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_SERVICE }} \
            --task-definition ${{ env.ECS_TASK_DEFINITION }} \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

      - name: Get ALB DNS name
        id: get-alb
        run: |
          # Get target group ARN from ECS service
          TARGET_GROUP_ARN=$(aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }} \
            --query 'services[0].loadBalancers[0].targetGroupArn' \
            --output text \
            --region ${{ env.AWS_REGION }} || echo "")
          
          if [ -z "$TARGET_GROUP_ARN" ] || [ "$TARGET_GROUP_ARN" == "None" ]; then
            echo "⚠️  No ALB configured - ECS service not using load balancer"
            echo "ALB_DNS_NAME=" >> $GITHUB_OUTPUT
            echo "ALB_AVAILABLE=false" >> $GITHUB_OUTPUT
            echo "TARGET_GROUP_ARN=" >> $GITHUB_OUTPUT
          else
            # Get ALB ARN from target group
            ALB_ARN=$(aws elbv2 describe-target-groups \
              --target-group-arns "$TARGET_GROUP_ARN" \
              --query 'TargetGroups[0].LoadBalancerArns[0]' \
              --output text \
              --region ${{ env.AWS_REGION }} || echo "")
            
            if [ -z "$ALB_ARN" ] || [ "$ALB_ARN" == "None" ]; then
              echo "⚠️  Could not find ALB for target group"
              echo "ALB_DNS_NAME=" >> $GITHUB_OUTPUT
              echo "ALB_AVAILABLE=false" >> $GITHUB_OUTPUT
              echo "TARGET_GROUP_ARN=" >> $GITHUB_OUTPUT
            else
              # Get ALB DNS name
              ALB_DNS=$(aws elbv2 describe-load-balancers \
                --load-balancer-arns "$ALB_ARN" \
                --query 'LoadBalancers[0].DNSName' \
                --output text \
                --region ${{ env.AWS_REGION }} || echo "")
              
              if [ -n "$ALB_DNS" ] && [ "$ALB_DNS" != "None" ]; then
                echo "✅ Found ALB: $ALB_DNS"
                echo "ALB_DNS_NAME=$ALB_DNS" >> $GITHUB_OUTPUT
                echo "ALB_AVAILABLE=true" >> $GITHUB_OUTPUT
                echo "TARGET_GROUP_ARN=$TARGET_GROUP_ARN" >> $GITHUB_OUTPUT
              else
                echo "⚠️  ALB DNS name not available"
                echo "ALB_DNS_NAME=" >> $GITHUB_OUTPUT
                echo "ALB_AVAILABLE=false" >> $GITHUB_OUTPUT
                echo "TARGET_GROUP_ARN=" >> $GITHUB_OUTPUT
              fi
            fi
          fi

      - name: Verify ALB health
        if: steps.get-alb.outputs.ALB_AVAILABLE == 'true'
        run: |
          echo "Checking ALB target health..."
          TARGET_GROUP_ARN="${{ steps.get-alb.outputs.TARGET_GROUP_ARN }}"
          
          HEALTH=$(aws elbv2 describe-target-health \
            --target-group-arn "$TARGET_GROUP_ARN" \
            --region ${{ env.AWS_REGION }} \
            --query 'TargetHealthDescriptions[*].[Target.Id,TargetHealth.State]' \
            --output table || echo "Could not check target health")
          
          echo "$HEALTH"

      - name: Output deployment info
        run: |
          echo "✅ Deployment Complete"
          echo "Image: $IMAGE_URI"
          echo "Service: ${{ env.ECS_SERVICE }}"
          echo "Cluster: ${{ env.ECS_CLUSTER }}"
          if [ "${{ steps.get-alb.outputs.ALB_AVAILABLE }}" == "true" ]; then
            echo "ALB DNS: ${{ steps.get-alb.outputs.ALB_DNS_NAME }}"
            echo "ALB Health Check: http://${{ steps.get-alb.outputs.ALB_DNS_NAME }}/health"
          fi


